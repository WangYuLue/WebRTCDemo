<div>
    <video></video>
</div>
<script src="../js/simplepeer.min.js"></script>
<script src="../js/socket.io.js"></script>
<script>
    let socket = io('http://localhost:8999');
    let Peers = {};
    let remote_local = {}; //本地Peer和远程SocketIO的一一对照

    let localstream = null;

    navigator.getUserMedia({ video: true, audio: true }, gotMedia, function () {})

    function gotMedia (stream) {
        localstream = stream;
        let video = document.querySelector('video');
        video.srcObject = stream;
        video.play();
        socket.emit("interviewer_start");  //本地视频流加载后，开始广播到管理端
    }

    socket.on("hello",function(data){
        console.log(data);
    })

    socket.on("signal",function(data){
        Peers[remote_local[data.from_socket_id]].signal(data.data);
    })

    socket.on("interviewer_recive_reply",function(data){
        console.log('interviewer_recive_reply',data);
        createPeer(data);
    })

    socket.on("interviewer_start",function(data){
        console.log("recive start",data);
        createPeer(data,true);
    })

    function createPeer(data,flag) {
        let peer = new SimplePeer({ initiator: true, stream: localstream })
        Peers[peer._id] = peer;
        remote_local[data.manager_socket_id] = peer._id;
        Peers[peer._id].on('signal', function (d) {
            socket.emit("signal", {
                to_socket_id : data.manager_socket_id,
                data : d
            });
        })
        if(flag){
            socket.emit("interviewer_reply", data);
        }
    }
</script>